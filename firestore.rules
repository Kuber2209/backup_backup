rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    // Role checking function - simplified for robustness
    function getRole(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.role;
    }
    
    function isSPT(userId) {
      return request.auth != null && getRole(userId) == 'SPT';
    }

    function isJPT(userId) {
      return request.auth != null && getRole(userId) == 'JPT';
    }
    
    // == USERS ==
    match /users/{userId} {
      // Allow any authenticated user to create their OWN document.
      // This is secure because the app logic ensures they create a document with their own UID.
      allow create: if request.auth != null && request.auth.uid == userId;

      // Users can READ their OWN document.
      // SPTs can READ ANY user document.
      allow read: if isOwner(userId) || isSPT(request.auth.uid);
      
      // Users can UPDATE their own profile.
      // SPTs can UPDATE ANY profile (for role changes, etc.).
      allow update: if isOwner(userId) || isSPT(request.auth.uid);
      
      // Only SPTs can delete users.
      allow delete: if isSPT(request.auth.uid);
    }

    // == TASKS ==
    match /tasks/{taskId} {
      // ANY authenticated user can read tasks.
      allow read: if request.auth != null;

      // Only JPTs or SPTs can create, update, or delete tasks.
      allow write: if isJPT(request.auth.uid) || isSPT(request.auth.uid);
      
      // Subcollection for messages within a task.
      match /messages/{messageId} {
         // Any authenticated user can read and create messages.
         allow read, create: if request.auth != null;
         
         // Users can only update/delete their own messages (if you track ownership).
         allow update, delete: if request.auth != null && 
                                  resource.data.userId == request.auth.uid;
      }
    }

    // == ANNOUNCEMENTS ==
    match /announcements/{announcementId} {
      // ANY authenticated user can read announcements.
      allow read: if request.auth != null;
      
      // Only JPTs or SPTs can create, update, or delete announcements.
      allow write: if isJPT(request.auth.uid) || isSPT(request.auth.uid);
    }
    
    // == RESOURCES ==
    match /resources/{resourceId} {
       // ANY authenticated user can read and update resources.
       allow read, update: if request.auth != null;
       
       // Only JPTs or SPTs can create or delete resources.
       allow create, delete: if isJPT(request.auth.uid) || isSPT(request.auth.uid);
    }

    // == PITCH LISTS ==
    match /pitchLists/{pitchListId} {
      // Any authenticated user can read and write pitch lists.
      allow read, write: if request.auth != null;

      // Subcollection for contacts within a pitch list.
      match /contacts/{contactId} {
        // Any authenticated user can read and write contacts.
        allow read, write: if request.auth != null;
      }
    }

    // == ADMIN-ONLY COLLECTIONS ==
    // Whitelist and Blacklist can only be accessed by SPTs.
    match /whitelist/{email} {
      allow read, write: if isSPT(request.auth.uid);
    }
    
    match /blacklist/{email} {
       allow read, write: if isSPT(request.auth.uid);
    }

  }
}
