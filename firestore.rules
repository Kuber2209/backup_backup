rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    // Safe role checking that won't break for new users
    function userExists() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function getRole() {
      // Only try to get role if user document exists
      return userExists() 
        ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role 
        : 'user'; // Default to 'user' role for new accounts
    }
    
    function isSPT() {
      return request.auth != null && getRole() == 'SPT';
    }

    function isJPT() {
      return request.auth != null && getRole() == 'JPT';
    }
    
    // == USERS ==
    match /users/{userId} {
      // ANY authenticated user can CREATE a user document.
      // The app logic ensures they only create their own.
      allow create: if request.auth != null;

      // Users can READ or UPDATE their OWN document.
      // An SPT can READ or UPDATE ANY user document.
      allow read: if isOwner(userId) || isSPT();
      
      // Users can update their own profile, SPTs can update any profile
      allow update: if isOwner(userId) || isSPT();
      
      // Only SPTs can delete users.
      allow delete: if isSPT();
    }

    // == TASKS ==
    match /tasks/{taskId} {
      // ANY authenticated user can read tasks.
      allow read: if request.auth != null;

      // Only JPTs or SPTs can create, update, or delete tasks.
      allow write: if isJPT() || isSPT();
      
      // Subcollection for messages within a task.
      match /messages/{messageId} {
         // Any authenticated user can read and create messages.
         allow read, create: if request.auth != null;
         
         // Users can only update/delete their own messages (if you track ownership).
         // Comment this out if you want all users to edit all messages.
         allow update, delete: if request.auth != null && 
                                  resource.data.userId == request.auth.uid;
      }
    }

    // == ANNOUNCEMENTS ==
    match /announcements/{announcementId} {
      // ANY authenticated user can read announcements.
      allow read: if request.auth != null;
      
      // Only JPTs or SPTs can create, update, or delete announcements.
      allow write: if isJPT() || isSPT();
    }
    
    // == RESOURCES ==
    match /resources/{resourceId} {
       // ANY authenticated user can read and update resources.
       allow read, update: if request.auth != null;
       
       // Only JPTs or SPTs can create or delete resources.
       allow create, delete: if isJPT() || isSPT();
    }

    // == PITCH LISTS ==
    match /pitchLists/{pitchListId} {
      // Any authenticated user can read and write pitch lists.
      allow read, write: if request.auth != null;

      // Subcollection for contacts within a pitch list.
      match /contacts/{contactId} {
        // Any authenticated user can read and write contacts.
        allow read, write: if request.auth != null;
      }
    }

    // == ADMIN-ONLY COLLECTIONS ==
    // Whitelist and Blacklist can only be accessed by SPTs.
    match /whitelist/{email} {
      allow read, write: if isSPT();
    }
    
    match /blacklist/{email} {
       allow read, write: if isSPT();
    }

  }
}
