
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    function getRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }
    
    function isSPT() {
      return getRole() == 'SPT';
    }

    function isJPT() {
      return getRole() == 'JPT';
    }
    
    // == USERS ==
    // This collection stores user profile information.
    match /users/{userId} {
      // ANY authenticated user can CREATE their OWN user document.
      // This is the most important rule to fix the signup/login loop.
      allow create: if request.auth != null && request.auth.uid == userId;

      // Users can READ or UPDATE their OWN document.
      // An SPT (Super Admin) can READ or UPDATE ANY user document.
      allow read, update: if isOwner(userId) || isSPT();
      
      // Only SPTs can delete users (a destructive action).
      allow delete: if isSPT();
    }

    // == TASKS ==
    // This collection stores all tasks.
    match /tasks/{taskId} {
      // ANY authenticated user can read tasks.
      allow read: if request.auth != null;

      // Only JPTs or SPTs can create, update, or delete tasks.
      allow write: if isJPT() || isSPT();
      
      // Subcollection for messages within a task.
      match /messages/{messageId} {
         // Any user who can read the task can read/write messages.
         allow read, write: if request.auth != null;
      }
    }

    // == ANNOUNCEMENTS ==
    // This collection stores all announcements.
    match /announcements/{announcementId} {
      // ANY authenticated user can read announcements.
      allow read: if request.auth != null;
      
      // Only JPTs or SPTs can create, update, or delete announcements.
      allow write: if isJPT() || isSPT();
    }
    
    // == RESOURCES ==
    // This collection stores permanent resources like links and documents.
    match /resources/{resourceId} {
       // ANY authenticated user can read and update resources (e.g., to add comments).
       allow read, update: if request.auth != null;
       
       // Only JPTs or SPTs can create or delete resources.
       allow create, delete: if isJPT() || isSPT();
    }

    // == PITCH LISTS ==
    match /pitchLists/{pitchListId} {
      // Any authenticated user can read the lists of pitches.
      allow read, write: if request.auth != null;

      // Subcollection for contacts within a pitch list.
      match /contacts/{contactId} {
        // Any authenticated user can read and write contacts.
        allow read, write: if request.auth != null;
      }
    }

    // == ADMIN-ONLY COLLECTIONS ==
    // Whitelist and Blacklist can only be accessed by SPTs.
    match /whitelist/{email} {
      allow read, write: if isSPT();
    }
    
    match /blacklist/{email} {
       allow read, write: if isSPT();
    }

  }
}
